#!/usr/bin/env node
/**
 * API Adapter CLI Dispatcher
 */

import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { promises as fs } from 'fs';
import { checkApi } from '../src/check.mjs';
import { measureLatency } from '../src/latency.mjs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

async function main() {
    const args = process.argv.slice(2);

    if (args.length === 0) {
        showHelp();
        process.exit(0);
    }

    const command = args[0];
    const options = parseArguments(args.slice(1));

    // Ensure task directory exists
    if (options.taskDir) {
        const apiDir = join(options.taskDir, 'api');
        await fs.mkdir(apiDir, { recursive: true });
        options.apiDir = apiDir;
    }

    // Load files if provided
    if (options.commitmentPath) {
        try {
            options.commitment = JSON.parse(await fs.readFile(options.commitmentPath, 'utf8'));
        } catch (error) {
            console.error(`Error loading commitment: ${error.message}`);
        }
    }

    if (options.claimPath) {
        try {
            options.claim = JSON.parse(await fs.readFile(options.claimPath, 'utf8'));
        } catch (error) {
            console.error(`Error loading claim: ${error.message}`);
        }
    }

    if (options.profilePath) {
        try {
            options.profile = JSON.parse(await fs.readFile(options.profilePath, 'utf8'));
        } catch (error) {
            console.error(`Error loading profile: ${error.message}`);
        }
    }

    // Execute command
    try {
        switch (command) {
            case 'api:check':
                await checkApi(options);
                console.log(`✓ API schema check complete: ${options.apiDir}/schema_result.json`);
                break;

            case 'api:latency':
                await measureLatency(options);
                console.log(`✓ Latency measurement complete: ${options.apiDir}/latency.json`);
                break;

            case 'api:all':
                // Run all adapters
                console.log('Running all API verification adapters...');

                await checkApi(options);
                console.log('  ✓ Schema check complete');

                await measureLatency(options);
                console.log('  ✓ Latency measurement complete');

                console.log(`\n✓ All API verification complete in ${options.apiDir}/`);
                break;

            default:
                console.error(`Unknown command: ${command}`);
                showHelp();
                process.exit(1);
        }
    } catch (error) {
        console.error(`Error executing ${command}:`, error.message);
        process.exit(1);
    }
}

function parseArguments(args) {
    const options = {
        taskDir: '.artifacts/current',
        commitmentPath: null,
        claimPath: null,
        profilePath: null,
        commitment: {},
        claim: {},
        profile: {}
    };

    for (let i = 0; i < args.length; i++) {
        switch (args[i]) {
            case '--task-dir':
                if (args[i + 1]) {
                    options.taskDir = args[i + 1];
                    i++;
                }
                break;

            case '--commitment':
                if (args[i + 1]) {
                    options.commitmentPath = args[i + 1];
                    i++;
                }
                break;

            case '--claim':
                if (args[i + 1]) {
                    options.claimPath = args[i + 1];
                    i++;
                }
                break;

            case '--profile':
                if (args[i + 1]) {
                    options.profilePath = args[i + 1];
                    i++;
                }
                break;

            case '--url':
                if (args[i + 1]) {
                    options.url = args[i + 1];
                    i++;
                }
                break;

            case '--schema':
                if (args[i + 1]) {
                    options.schemaPath = args[i + 1];
                    i++;
                }
                break;
        }
    }

    return options;
}

function showHelp() {
    console.log(`
API Adapter CLI - API endpoint verification

Usage: adapter-api <command> [options]

Commands:
  api:check         Validate API responses against JSON Schema
  api:latency       Measure API latency (p50/p95)
  api:all           Run all API verification adapters

Options:
  --task-dir <path>      Directory for artifacts (default: .artifacts/current)
  --commitment <file>    Path to commitment.json file
  --claim <file>         Path to claim.json file
  --profile <file>       Path to verification profiles file
  --url <url>            API endpoint URL (overrides commitment/profile)
  --schema <file>        Path to JSON Schema file (overrides commitment/profile)

Examples:
  adapter-api api:check --task-dir .artifacts/T_api_1 --url https://api.example.com/user --schema schema.json
  adapter-api api:latency --task-dir .artifacts/T_api_1 --url https://api.example.com/user
  adapter-api api:all --task-dir .artifacts/T_api_1 --commitment commitment.json --profile profiles.json

Output:
  Each command creates JSON files in the task directory/api/:
  - schema_result.json
  - latency.json
`);
}

// Run main function
main().catch(error => {
    console.error('Fatal error:', error);
    process.exit(1);
});